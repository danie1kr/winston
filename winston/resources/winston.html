<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>winston</title>
    <link rel="stylesheet" href="./materialicons.css">
    <script type="text/javascript" src="lodash.min.js"></script>
    <script type="text/javascript" src="zepto.min.js"></script>

    <link type="text/css" rel="stylesheet" href="materialize.min.css" media="screen,projection" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="white" />
    <meta name="description" content="winston model train remote">

    <style>
        #overlay {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            padding-top: 30%;
            z-index: 500000;
            cursor: pointer;
        }

        #railway {
            position: absolute;
            /*min-height: 100vh;*/
            width: calc(100% - 600px);
            height: calc(100% - 64px);
            z-index: 3000;
        }

        .contextMenu {
            position: absolute;
            z-index: 5000;
            background-color: white;
            border-color: #26a69a;
            border-radius: 2px;
            border-style: solid;
            box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2);
            padding: 8px;
        }

        #settingsToggle {
            font-size: larger;
        }

        #settingsContent {
            position: fixed;
            width: calc(100% - 600px);
            background-color: white;
            z-index: 10000;
            padding: 20px 20px 20px 20px;
        }

        #logsContent {
            position: fixed;
            overflow-y: scroll;
            background-color: white;
            bottom: 0px;
            width: calc(100% - 600px);
            height: 32%;
            z-index: 10000;
            padding: 20px 20px 20px 20px;
        }

            #logsContent tr td:nth-child(1), #logsContent tr td:nth-child(2) {
                width: 10%;
            }

            #logsContent tr td:last-child {
                max-width: 0;
                min-width: fit-content;
                white-space: nowrap;
                text-overflow: ellipsis;
            }

        body {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }

        header, main, footer {
            margin-left: 300px;
            margin-right: 300px;
            width: calc(100% - 600px);
        }

        main {
            flex: 1 0 auto;
        }

        footer {
            padding-top: 0px;
            height: 24px;
            z-index: 4000;
        }

        #message {
            margin-left: 8px;
        }

        #connection {
            position: absolute;
            padding-left: 10px;
            bottom: 8%;
            /* height: 8%; */
            overflow: auto;
        }

        .labelTrackNode {
            font-size: 0.8em;
        }

        .microButton {
            padding: 0 0;
        }

            .microButton > i {
                margin: 0 0 0 0;
            }

        .switch.lever {
            margin: 0 0 0 0;
        }

        div.collapsible-header {
        }

            div.collapsible-header > div.row {
                width: 100%;
            }

        .brand-logo {
            margin-left: 16px;
            margin-right: 16px;
        }

        .sideNavTitle {
            margin: 0 0 0 0;
            padding: 12px 16px 12px 16px;
        }
    </style>

    <!-- templates -->
    <script type="text/template" id="template_turnout">
        <div class="winston-turnout row" winston-turnout-track="<%= id %>" winston-turnout-direction="<%= direction %>">
            <div class="name col s4"><%= name %></div><div class="direction col s3"><%= direction %></div>

            <div class="col s2"><a class="waves-effect waves-light btn">toggle</a></div>
        </div>
    </script>

    <script type="text/template" id="template_loco_function">
        <div class="row">
            <div class="address col s6"><%= name %></div>
            <div class="col s6 switch">
                <label>
                    <input type="checkbox" class="<%= function_class %>" winston-loco-function="<%= function_id %>">
                    On <span class="lever"></span> Off
                </label>
            </div>
        </div>
    </script>

    <script type="text/template" id="template_loco">
        <li>
            <div class="collapsible-header">
                <div class="row">
                    <div class="col s4"><%= name %></div>
                    <div class="col s6 switch">
                        <label>
                            <i class="small material-icons">highlight</i>
                            <input type="checkbox" class="light">
                            <span class="lever"></span>
                        </label>
                    </div>
                    <div class="col s2">
                        <a class="waves-effect waves-light btn-small microButton stop">
                            <i class="small material-icons">dangerous</i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="collapsible-body">
                <div class="winston-locomotive row" winston-loco-address="<%= address %>" winston-type="locomotive" winston-id="<%= address %>">
                    <div class="row">
                        <div class="address col s4">DCC: <%= address %></div>
                        <div class="col s4">
                            <label class="speedValue"></label>
                        </div>
                        <div class="col s4"><a class="waves-effect waves-light btn">stop</a></div>
                    </div>
                    <div class="row">
                        <input class="speed" type="range" min="-100" max="100" />
                    </div>
                    <div class="functions">

                    </div>
                    <hr>
                </div>
            </div>
        </li>
    </script>

    <script type="text/template" id="template_detector_debug_loco">
        <option value="<%= id %>"><%= name %></option>
    </script>

    <script type="text/template" id="template_log_entry">
        <tr>
            <td><%= timestamp %></td>
            <td><%= level %></td>
            <td><%= text %></td>
        </tr>
    </script>

    <script type="text/template" id="template_route">
        <div class="col s6 switch winston-route" winston-route="<%= id %>">
            <label>
                <%= name %>
                <input type="checkbox" class="set">
                <span class="lever"></span>
            </label>
        </div>
    </script>
</head>

<body>
    <!-- overlay -->
    <div id="overlay">
        <div class="row status">
            <div class="div col s8 offset-s2 valign-wrapper">
                <div class="content">
                </div>
            </div>
        </div>
        <div class="row prog">
            <div class="div col s8 offset-s2 valign-wrapper">
                <div class="progress">
                    <div class="indeterminate">
                    </div>
                </div>
            </div>
        </div>
        <div class="row button">
            <div class="div col s8 offset-s5 valign-wrapper">
                <a class="waves-effect waves-light btn" id="reconnect">reconnect</a>
            </div>
        </div>
    </div>

    <!-- context menus -->
    <div id="menuTrackEdge" class="contextMenu">
        <a id="splitEdge" class="waves-effect waves-light btn cancel">split track</a>
        <a class="waves-effect waves-light btn cancel">cancel</a>
    </div>

    <div id="menuTrackNode" class="contextMenu">
        <a id="deleteTrackNode" class="waves-effect waves-light btn cancel">delete node</a>
        <a class="waves-effect waves-light btn cancel">cancel</a>
    </div>

    <div id="menuEditNode" class="contextMenu">
        <a id="pullConnectedNode" class="waves-effect waves-light btn cancel">pull connected node</a>
        <a class="waves-effect waves-light btn cancel">cancel</a>
    </div>

    <div id="menuTrackNode" class="contextMenu row">
        <div class="input-field col">
            <input placeholder="name" id="trackNodeName" type="text" class="validate">
            <label for="trackNodeName">Name</label>
        </div>
        <div class="col">
            <a class="waves-effect waves-light btn cancel">cancel</a>
        </div>
    </div>

    <div id="infoSignal" class="contextMenu">
        <ul class="collapsible expandable">
            <li class="active showOnEditOnly">
                <div class="collapsible-header">Layout</div>
                <div class="collapsible-body">
                    <div class="row showOnEditOnly">
                        <div class="col">
                            <a class="waves-effect waves-light btn rotate">rotate 45°</a>
                        </div>
                    </div>
                </div>
            </li>
            <li>
                <div class="collapsible-header">Info</div>
                <div class="collapsible-body">
                    <div class="row>">
                        <div class="col">
                            <label for="infoSignalParent">Track</label>
                            <p id="infoSignalParent"></p>
                        </div>
                        <div class="col">
                            <label for="infoSignalConnection">Connection</label>
                            <p id="infoSignalConnection"></p>
                        </div>
                    </div>
                </div>
            </li>
            <li class="showIfRoutes">
                <div class="collapsible-header">Routes</div>
                <div class="collapsible-body">
                </div>
            </li>
            <li>
                <div class="collapsible-header">Lights</div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="col">
                            <label for="infoSignalLights">Lights</label>
                            <p id="infoSignalLights"></p>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>

    <div id="infoDebugDetector" class="contextMenu">
    </div>

    <header>
        <!-- top bar -->
        <nav>
            <div class="nav-wrapper white">
                <a href="#!" class="brand-logo teal-text">winston</a>
                <ul class="right hide-on-med-and-down">
                    <li><a class="waves-effect waves-light btn" id="logsToggle">Logs <i class="material-icons right">list</i></a></li>
                    <li><a class="waves-effect waves-light btn" id="stop">STOP <i class="material-icons right">dangerous</i></a></li>
                    <li><a class="waves-effect waves-light btn" id="settingsToggle">Settings <i class="material-icons right">settings</i></a></li>
                </ul>
            </div>
        </nav>
        <!-- settings -->
        <div id="settingsContent" class="row z-depth-3">
            <div class="input-field col s2"><input placeholder="IP" id="ip" type="text" class="validate" value="127.0.0.1"><label for="ip">IP</label></div>
            <div class="switch col s6">
                <div>Grid <label>hide <input id="gridView" type="checkbox"><span class="lever"></span>show</label></div>
                <div>Layout <label>fixed <input id="layoutEdit" type="checkbox"><span class="lever"></span>edit</label></div>
                <div>Blocks <label>view <input id="blockView" type="checkbox"><span class="lever"></span>off</label></div>
                <div>
                    Detector Debug <label>on <input id="detectorDebug" type="checkbox"><span class="lever"></span>off</label>
                    <div class="input-field col s12">
                        <select id="detectorDebugLoco">
                            <option value="" disabled selected>Choose a locomotive</option>
                        </select>
                        <label>Detector </label>
                    </div>
                </div>
                <a id="saveLayout" class="waves-effect waves-light btn-small">Save Layout</a>
                <a id="resetLayout" class="waves-effect waves-light btn-small">Reset Layout</a>
            </div>
        </div>
        <div id="error"></div>
    </header>

    <main id="container">
        <!-- right side -->
        <ul id="sideLoco" class="sidenav sidenav-fixed">
            <h6 class="sideNavTitle grey lighten-4">Locomotives</h6>
            <ul class="collapsible expandable" id="locoShedContainer">
            </ul>
        </ul>

        <!-- left side -->
        <ul id="sideTurnout" class="sidenav sidenav-fixed">
            <ul class="collapsible expandable">
                <li id="routesContainer" class="active">
                    <div class="collapsible-header">Routes</div>
                    <div class="collapsible-body"></div>
                </li>
                <li id="turnoutsContainer" class="">
                    <div class="collapsible-header">Turnouts</div>
                    <div class="collapsible-body"></div>
                </li>
            </ul>
        </ul>

        <!-- main view -->
        <div id="railway"></div>
    </main>

    <!-- bottom -->
    <footer class="page-footer white black-text z-depth-1">
        <div id="message">
        </div>
        <div id="logsContent">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Level</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody id="log">
                </tbody>
            </table>
        </div>
    </footer>

    <script type="text/javascript">

        /* socket */
        const SocketClosed = 0;
        const SocketConnecting = 1;
        const SocketOpen = 2;

        let socketState = SocketClosed;
        let socket = null;

        const SocketReconnectTimeout = 10 * 1000;
        function connect() {
            socketState = SocketConnecting;
            socket = new WebSocket("ws://" + $("#ip").val());

            socket.onmessage = function (event) {
                parse(JSON.parse(event.data));
            }

            socket.onopen = function (event) {
                socketState = SocketOpen;
                $("#connection").html("connected");
                $("#overlay .status").hide();
                $("#overlay").hide();
            }

            socket.onclose = function (event) {

                if (socketState === SocketConnecting)
                    _.delay(connect, SocketReconnectTimeout);

                socketState = SocketClosed;
                $("#connection").html("not connected");
                $("#overlay .status").hide();
                $("#overlay").show();
            }
        }

        function onConnect() {
            send("getStatus", {});
            send("getRailway", {});
            send("getLocoShed", {});
            send("getLogs", {});
        }

        /* variables and constants */
        let railway, signals, blocks, detectors, routes, layout, $railway, $saveLayout, $resetLayout, cy, uiEditLayout = false, allowLayoutStorage = true, allowLayoutLoading = true;

        const WinstonTypeTurnout = "turnout";
        const WinstonTypeLocomotive = "locomotive";
        const TurnoutState_A_B = 0;
        const TurnoutState_A_C = 1;
        const TurnoutState_Changing = 2;

        const DoubleSlipTurnoutState_A_B = 0;
        const DoubleSlipTurnoutState_A_C = 1;
        const DoubleSlipTurnoutState_C_D = 2;
        const DoubleSlipTurnoutState_B_D = 3;
        const DoubleSlipTurnoutState_Changing = 4;

        const RouteState_Unset = 0;
        const RouteState_Setting = 1;
        const RouteState_Set = 2;

        function turnoutDirectionLabelFromDirection(direction) {
            switch (direction) {
                case 0: return "A-B";
                case 1: return "A-C";
                default:
                    return "changing";
            }
        }

        function doubleSlipDirectionLabelFromDirection(direction) {
            switch (direction) {
                case 0: return "A-B";
                case 1: return "A-C";
                case 2: return "C-D";
                case 3: return "B-D";
                default:
                    return "changing";
            }
        }

        /* helpers */
        function allowLayoutEdit() {
            return uiEditLayout === true;
        }

        function allowWinstonSubmit() {
            return uiEditLayout === false;
        }

        function winstonGet(type, id) {
            return $("[winston-type=\"" + type + "\"][winston-id=\"" + id + "\"]");
        }

        /* websocket receive */
        function parse(content) {
            let op = content.op;
            let data = content.data;

            switch (op) {
                case "turnoutState": { turnoutState(data); break; }
                case "signalState": { signalState(data); break; }
                case "routeState": { routeState(data); break; }
                case "railway": { buildRailwayGraph(data); break; }
                case "layout": { updateRailwayLayout(data); break; }
                case "loco": { loco(data); break; }
                case "log": { log(data); break; }
                case "status": { status(data); break; }
                case "storeRailwayLayoutSuccessful": {
                    allowLayoutStorage = data;
                    if (allowLayoutStorage)
                        $saveLayout.removeClass("disabled");
                    message("layout storage successful: " + data); break;
                }
                case "locoPositions": { locoPositions(data); break; }
                case "error": { error(data); break; }
                default:
                    {
                        error("unparsable op:" + op);
                        break;
                    }
            }
        }

        function turnoutState(data) {
            let id = data.id;
            let direction = data.state;

            let turnout = cy.nodes(".turnout[track=\"" + id + "\"]").data("direction", direction);
            if (turnout.data("type") === "turnout")
                turnoutUpdate(turnout);
            else
                doubleSlipTurnoutUpdate(turnout);
        }

        function signalState(data) {
            let track = data.parentTrack;
            let guarding = data.guarding;
            let aspects = data.aspects;

            let colorClass = "black";

            if (aspects & 0b00001) colorClass = "black";        // Off
            else if (aspects & 0b00100) colorClass = "red";     // Halt
            else if (aspects & 0b00010) colorClass = "green";   // Go
            else if (aspects & 0b01000) colorClass = "yellow";  // ExpectHalt
            else if (aspects & 0b10000) colorClass = "teal";    // ExpectGo

            let signal = cy.nodes(".signal[id=\"" + track + "_signal_" + guarding + "\"]")
                .data("aspects", aspects);
        }

        function routeState(data) {
            let $route = $(".winston-route[winston-route=\"" + data.id + "\"]");
            switch (data.state) {
                case RouteState_Unset:
                    $route.find("input").prop("disabled", "").prop("checked", "");
                    break;
                case RouteState_Setting:
                    $route.find("input").prop("disabled", "disabled").prop("checked", "checked");
                    break;
                case RouteState_Set:
                    $route.find("input").prop("disabled", "").prop("checked", "checked");
                    break;
            }
        }

        function loco(data) {
            let address = data.address;
            let $element = winstonGet(WinstonTypeLocomotive, address);

            if ($element === undefined || $element.length === 0) {
                let $locoShedContainer = $("#locoShedContainer");
                let locoTemplate = _.template($("#template_loco").html());
                $element = $(locoTemplate({ address: address, name: data.name }));
                $element.find(".speed").on("change", doControlLoco);
                $element.find(".light").on("change", doControlLoco);
                $element.find(".stop").on("click", function (event) {
                    $element.find(".speed").val(0);
                    doControlLoco(event);
                    return false;
                });

                let $functions = $element.find(".functions");
                _.each(data.functions, func => {
                    if (func.id == 0)
                        return;
                    let template = _.template($("#template_loco_function").html());
                    let $func = $(template({ name: func.name, function_class: "function_" + func.id, function_id: func.id }));
                    $func.find("input").on("change", event => {

                    });
                    $functions.append($func);
                });

                $locoShedContainer.append($element);
                M.Collapsible.init(document.querySelector('#locoShedContainer'));
            }

            let $elementDetectorDebugLoco = $("#detectorDebugLoco>option[value=\"" + address + "\"]");
            if ($elementDetectorDebugLoco === undefined || $elementDetectorDebugLoco.length === 0) {
                let $detectorDebugLocoSelect = $("#detectorDebugLoco");
                let locoTemplate = _.template($("#template_detector_debug_loco").html());
                $element = $(locoTemplate({ id: address, name: data.name }));
                $detectorDebugLocoSelect.append($element);
                M.FormSelect.init(document.querySelectorAll('select'));
            }

            let locoNode = cy.$("node.locomotive[address=\"" + address + "\"]");
            if (locoNode === undefined || locoNode === 0) {
                locoNode = { group: 'nodes', data: { address: address }, classes: "locomotive" };
                cy.add(locoNode);
            }
            $element.find(".speed").val(data.forward ? data.speed : -data.speed);
            $element.find(".speedValue").html(data.value);
            $element.find(".light").prop("checked", data.light ? "checked" : undefined);
        }

        function populateRoutesUI(routes) {
            let $routesContainerBody = $("#routesContainer>div.collapsible-body");
            $routesContainerBody.empty();
            _.each(routes, route => {
                let routeTemplate = _.template($("#template_route").html());
                let $route = $(routeTemplate({ id: route.id, name: route.name }));
                $route.find(".set").on("change", function (event) {
                    let $target = $(event.target);
                    let $closest = $($target.closest(".winston-route"));
                    sendRoute($closest.attr("winston-route"), $target.prop("checked"));
                    $target.prop("disabled", "disabled");
                });
                $routesContainerBody.append($route);
            });
        }

        function log(data) {
            let entryTemplate = _.template($("#template_log_entry").html());
            let $entry = $(entryTemplate({ timestamp: data.timestamp, level: data.level, text: data.text }));
            $("#log").prepend($entry);
            $("#message").html("[" + data.level + "]: " + data.text);
            console.log(data.timestamp + " - [" + data.level + "]: " + data.text);
        }

        function status(data) {
            if (data.connected) {
                $("#overlay").hide();
            }
            else {
                $("#overlay .status .content").text("digital station not connected");
                $("#overlay .status").show();
                $("#overlay").show();
            }
        }

        function locoPositions(data) {
            _.each(data, loco => {
                let locoNode = cy.$("node.locomotive[address=\"" + loco.address + "\"]");

            });
        }

        function error(data) {
            $("#error").append($("<p>").html(data));
            console.error(data);
        }

        function message(data) {
            $("#message").append($("<p>").html(data));
            console.log(data);
        }

        /* socket send */
        function send(op, data) {
            if (socketState === SocketOpen)
                socket.send(JSON.stringify({ op: op, data: data }));
            else
                setTimeout(send, 100, op, data);
        }

        function turnoutGet(id) {
            return winstonGet(WinstonTypeTurnout, id);
        }

        function turnoutUpdate(turnout) {
            let direction = turnout.data("direction");
            let track = turnout.data("track");
            switch (direction) {
                case TurnoutState_A_B:
                    turnout.neighborhood("[connection=\"b\"]").style("visibility", "visible");
                    turnout.neighborhood("[connection=\"c\"]").style("visibility", "hidden");
                    break;
                case TurnoutState_A_C:
                    turnout.neighborhood("[connection=\"b\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"c\"]").style("visibility", "visible");
                    break;
                default:
                case TurnoutState_Changing:
                    turnout.neighborhood("[connection=\"b\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"c\"]").style("visibility", "hidden");
                    break;
            }

            $(".winston-turnout[winston-turnout-track=\"" + track + "\"]>.direction").html(turnoutDirectionLabelFromDirection(direction));
        }

        function doubleSlipTurnoutUpdate(turnout) {
            let direction = turnout.data("direction");
            let track = turnout.data("track");
            switch (direction) {
                case DoubleSlipTurnoutState_A_B:
                    turnout.neighborhood("[connection=\"a\"]").style("visibility", "visible");
                    turnout.neighborhood("[connection=\"b\"]").style("visibility", "visible");
                    turnout.neighborhood("[connection=\"c\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"d\"]").style("visibility", "hidden");
                    break;
                case DoubleSlipTurnoutState_A_C:
                    turnout.neighborhood("[connection=\"a\"]").style("visibility", "visible");
                    turnout.neighborhood("[connection=\"b\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"c\"]").style("visibility", "visible");
                    turnout.neighborhood("[connection=\"d\"]").style("visibility", "hidden");
                    break;
                case DoubleSlipTurnoutState_B_D:
                    turnout.neighborhood("[connection=\"a\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"b\"]").style("visibility", "visible");
                    turnout.neighborhood("[connection=\"c\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"d\"]").style("visibility", "visible");
                    break;
                case DoubleSlipTurnoutState_C_D:
                    turnout.neighborhood("[connection=\"a\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"b\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"c\"]").style("visibility", "visible");
                    turnout.neighborhood("[connection=\"d\"]").style("visibility", "visible");
                    break;
                default:
                case DoubleSlipTurnoutState_Changing:
                    turnout.neighborhood("[connection=\"a\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"b\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"c\"]").style("visibility", "hidden");
                    turnout.neighborhood("[connection=\"d\"]").style("visibility", "hidden");
                    break;
            }

            $(".winston-turnout[winston-turnout-track=\"" + track + "\"]>.direction").html(doubleSlipDirectionLabelFromDirection(direction));
        }

        function turnoutToggle(event) {
            sendTurnoutToggle(event.target.data("track"), event.target.data("direction"));
        }

        function sendTurnoutToggle(track, direction) {
            if (!allowWinstonSubmit())
                return;

            let id = track;
            let turnout = cy.nodes(".turnout[track=\"" + id + "\"]").off("click");

            if ((turnout.data("type") === "turnout" && direction !== TurnoutState_Changing) ||
                (turnout.data("type") === "doubleSlipTurnout" && direction !== DoubleSlipTurnoutState_Changing))
                send("doTurnoutToggle", { id: id });
        }

        function sendRoute(id, set) {
            if (!allowWinstonSubmit())
                return;
            send("doRouteSet", { id: id, set: set });
        }

        function turnoutRequestStatus(track) {
            if (!allowWinstonSubmit())
                return;
            send("getTurnoutState", { id: track });
        }

        function signalRequestStatus(guarding, parentTrack) {
            if (!allowWinstonSubmit())
                return;
            send("getSignalState", { parentTrack: parentTrack, guarding: guarding });
        }

        function doControlLoco(event) {
            let $target = $(event.target);
            let $loco = $($target.closest(".winston-locomotive"));
            let speed = parseInt($loco.find(".speed").val());

            send("doControlLoco", {
                address: parseInt($loco.attr("winston-loco-address")),
                light: $loco.find(".light").prop("checked"),
                forward: speed > 0,
                speed: speed
            });
        }

        function storeRailwayLayout() {
            let layout =
            {
                viewport: { zoom: cy.zoom(), pan: cy.pan() },
                cy: cy.$().jsons()
            }

            let payload = JSON.stringify(layout);
            let offset = 0;
            let size = 0;
            let chunkSize = 32000;
            for (let i = 0; i < payload.length; i += chunkSize)
                send("storeRailwayLayout", { layout: payload.substring(i, Math.min(i + chunkSize, payload.length)), offset: i, fullSize: payload.length });

        }

        /* context menus */
        function hideContextMenus() {
            $(".contextMenu").hide();
        }

        function click(menu, event) {
            if (!allowLayoutEdit()) {
                graphCalculateReachability(event)
                return;
            }
            else {
                hideContextMenus();

                let $contextMenu = $("#" + menu);
                if (menu === "menuTrackNode") {
                    let node = event.target;
                    let name = node.data("displayName");
                    $("#trackNodeName")
                        .val(name ? name : node.data("name"))
                        .off('change')
                        .on('change', function (e) {
                            let name = e.target.value;
                            node.data("displayName", name);
                            $("#turnoutsContainer>div.collapsible-body")
                                .find("[winston-turnout-track=\"" + node.data("track") + "\"]")
                                .find(".name")
                                .html(name);
                        });

                }

                $contextMenu
                    .css("top", event.originalEvent.clientY + 'px')
                    .css("left", (event.originalEvent.clientX + 20) + 'px')
                    .show();
            }
        }

        function signalInfo(event) {
            hideContextMenus();
            let $info = $("#infoSignal");
            let node = event.target;

            if (allowLayoutEdit()) {
                $info.find(".showOnEditOnly").show();
                let $rotate = $info.find(".rotate");
                $rotate.off('click').on('click', () => {
                    let value = node.data("rotation") || 0;
                    node.data("rotation", (value + 45) % 360);
                });
            }
            else
                $info.find(".showOnEditOnly").hide();

            if (node.data("routes")) {
                $info.find(".showIfRoutes").show();
                let $routesContainer = $info.find(".showIfRoutes div.collapsible-body");
                $routesContainer.empty();
                _.each(node.data("routes"), route => {
                    let routeTemplate = _.template($("#template_route").html());
                    let $route = $(routeTemplate({ id: route.id, name: route.name }));
                    $route.find(".set").on("change", function (event) {
                        let $target = $(event.target);
                        let $closest = $($target.closest(".winston-route"));
                        sendRoute($closest.attr("winston-route"), $target.prop("checked"));
                        $target.prop("disabled", "disabled");
                    });
                    $routesContainer.append($route);
                });
            }
            else
                $info.find(".showIfRoutes").hide();

            $info.find("#infoSignalParent").text(node.data("parentTrack"));
            $info.find("#infoSignalConnection").text(node.data("guarding"));
            let lights = _.map(node.data("lights"), l => " Port: " + l.port)
            let lightsText = lights.join("<br>");
            $info.find("#infoSignalLights").html(lightsText);
            $info.css("top", event.originalEvent.clientY + 'px')
                .css("left", (event.originalEvent.clientX + 20) + 'px')
                .show();
        }

        function sendInjectDetector(locoAddress, id) {
            if (!allowWinstonSubmit())
                return;
            send("emu_dcs_inject_detector", { loco: locoAddress, id: id });
        }

        function detectorClick(event) {

            if ($("#detectorDebug").prop("checked")) {
                let loco = $("#detectorDebugLoco").val();
                let node = event.target;
                sendInjectDetector(loco, node.data("detectorId"));
            }
            else {
                hideContextMenus();
                // infoDebugDetector
                // show connection info
            }
        }

        /* cytoscape */
        function cytoscapeCreate() {
            return cy = cytoscape({
                container: $railway,
                layout: { name: 'preset' },
                boxSelectionEnabled: true,
                panningEnabled: true,
                style: [
                    {
                        selector: ".trackConnector",
                        style: {
                            "line-color": '#F00',
                            "width": 10
                        }
                    },
                    {
                        selector: ".internal",
                        style: {
                            "line-color": 'orange',
                            "width": 8
                        }
                    },
                    {
                        selector: ".trackNode",
                        style: {
                            "width": 20,
                            "height": 20,
                            "shape": "rectangle"
                        }
                    },
                    {
                        selector: ".trackSplitNode",
                        style: {
                            "width": 8,
                            "height": 8,
                            "shape": "rectangle"
                        }
                    },
                    {
                        selector: ".track",
                        style: {
                            "width": 8
                        }
                    },
                    {
                        selector: ".connection",
                        style: {
                            "width": 8,
                            "height": 8
                        }
                    },
                    {
                        selector: ".connector",
                        style: {
                            "width": 8,
                            "height": 8
                        }
                    },
                    {
                        selector: ".highlight",
                        style: {
                            "background-color": "orange",

                        }
                    },
                    {
                        selector: ".reachable",
                        style: {
                            "line-color": 'green',
                        }
                    },
                    {
                        selector: ".signalConnector",
                        style: {
                            "width": 1
                        }

                    },
                    {
                        selector: ".signal",
                        style: {
                            "width": 10,
                            "height": 10,
                            "shape": "octagon",
                        }
                    },
                    {
                        selector: ".signal.routeStart",
                        style: {
                            "background-color": "skyblue"
                        }
                    },
                    {
                        selector: "node.detector",
                        style: {
                            "width": 24,
                            "height": 24,
                            "shape": "rectangle",
                            "background-color": "red"
                        }

                    },
                    {
                        selector: "edge.detector",
                        style: {
                            "width": 1
                        }

                    },
                    {
                        selecotr: "node.locomotive",
                        style: {
                            "width": 8,
                            "height": 8,
                            "shape": "diamond"
                        }
                    },
                    {
                        selector: "node.blockColoring",
                        style: {
                            "background-color": "data(blockColor)"
                        }
                    },
                    {
                        selector: "edge.blockColoring",
                        style: {
                            "line-color": "data(blockColor)"
                        }
                    }
                ]
            }).gridGuide({
                snapToGridOnRelease: true,
                snapToGridDuringDrag: true,
                snapToGridCenter: false,
                gridSpacing: 10,
                guidelinesStyle: {
                    strokeStyle: "black",
                    horizontalDistColor: "#ff0000",
                    verticalDistColor: "green",
                    initPosAlignmentColor: "#0000ff",
                }
            }).nodeHtmlLabel([
                {
                    query: '.trackNode',
                    valign: "center",
                    halign: "center",
                    valignBox: "center",
                    halignBox: "center",
                    tpl: function (data) {
                        return '<p class="labelTrackNode">' + (data.address ? data.address : (data.displayName ? data.displayName : data.name)) + '</p>';
                    }
                },
                {
                    query: '.signal',
                    valign: "center",
                    halign: "center",
                    valignBox: "center",
                    halignBox: "center",
                    tpl: function (data) {
                        let html = "";
                        _.each(data.lights, l => {
                            let color = "black";
                            let symbol = "B";

                            if (l.aspect == 0b00100) { if (l.aspect & data.aspects) { color = "red"; } symbol = "●"; }
                            if (l.aspect == 0b00010) { if (l.aspect & data.aspects) { color = "green"; } symbol = "●"; }
                            if (l.aspect == 0b01000) { if (l.aspect & data.aspects) { color = "orange"; } symbol = "●"; }
                            if (l.aspect == 0b10000) { if (l.aspect & data.aspects) { color = "teal"; } symbol = "●"; }

                            html += '<span style="color:' + color + ';">' + symbol + '</span>';
                        });

                        return '<p style="transform: rotate(' + data.rotation + 'deg);">'
                            + html
                            + '</p>';
                    }
                }]);
        }

        function cytoscapePostAdd(cy) {
            cy.on('click', '.trackSplitNode', function (event) {
                click("menuTrackNode", event);
            });
            cy.on('click', '.track', function (event) {
                click("menuTrackEdge", event);
            });
            cy.on('click', '.connection, .connector', function (event) {
                click("menuEditNode", event);
            })
            cy.on('click', '.signal', function (event) {
                signalInfo(event);
            });
            cy.on('click', 'node.detector', function (event) {
                detectorClick(event);
            });
            cy.on('unselect', '.track, .trackNode, .track, .signal, .detector', function () {
                cy.elements().removeClass("reachable");
                hideContextMenus();
            });
            cy.on('mouseover', '.turnout', function (event) {
                event.target.neighborhood(".turnoutConnection").addClass("highlight");
            });
            cy.on('mouseout', '.turnout', function (event) {
                event.target.neighborhood(".turnoutConnection").removeClass("highlight");
            });

            cy.on('mouseover', '.trackNode', function (event) {
                event.target.neighborhood(".signalConnector").show();
            });
            cy.on('mouseout', '.trackNode', function (event) {
                event.target.neighborhood(".signalConnector").hide();
            });

            cy.on('position', '.trackNode', function () {
                if (!allowLayoutEdit())
                    return;
            });

            cy.on('position', '.bumper, .turnout, .rail', function (event) {
                if (!allowLayoutEdit())
                    return;
                let that = event.target;
                cy.$("node.connection[track=\"" + that.data("track") + "\"], node.trackSplitNode[track=\"" + that.data("track") + "\"]").each(function (e) {
                    if (!e.selected())
                        e.position({ x: that.position().x + e.data("relativePosition").x, y: that.position().y + e.data("relativePosition").y });
                });
            });

            cy.on('position', '.connection', function (event) {
                if (!allowLayoutEdit())
                    return;
                let that = event.target;
                let parentPosition = cy.$("node.trackNode[track=\"" + that.data("track") + "\"]").position();
                that.data("relativePosition", { x: that.position().x - parentPosition.x, y: that.position().y - parentPosition.y });

                that.neighborhood(".signal").each(function (e) {
                    if (!e.selected())
                        e.position({ x: that.position().x + e.data("relativePosition").x, y: that.position().y + e.data("relativePosition").y });
                });
            });

            cy.on('position', '.signal', function (event) {
                if (!allowLayoutEdit())
                    return;
                let that = event.target;
                let parentTrack = that.data("parentTrack");
                let $parent = cy.$("#" + parentTrack);
                let parentPosition =
                    ($parent.data("type") === "bumper" && that.data("guarding") === "deadend")
                        ? cy.$("node.trackNode.bumper[track=\"" + that.data("parentTrack") + "\"]").position()
                        : cy.$("node.connection." + that.data("guarding") + "[track=\"" + that.data("parentTrack") + "\"]").position();
                that.data("relativePosition", { x: that.position().x - parentPosition.x, y: that.position().y - parentPosition.y });
            });

            cy.on('click', '.turnout', turnoutToggle);

            cy.nodes().ungrabify();

            let $turnoutsContainerBody = $("#turnoutsContainer>div.collapsible-body");
            $turnoutsContainerBody.empty();
            cy.$(".turnout").each(function (turnout) {

                let turnoutTemplate = _.template($("#template_turnout").html());
                let $turnout = $(turnoutTemplate({ id: turnout.data("track"), name: turnout.data("address") ? turnout.data("address") : (turnout.data("displayName") ? turnout.data("displayName") : turnout.data("name")), direction: turnout.data("direction") }));
                $turnout.on('click', function (event) {
                    let $target = $(event.target);
                    let $closest = $($target.closest(".winston-turnout"));
                    sendTurnoutToggle($closest.attr("winston-turnout-track"), $closest.attr("winston-turnout-direction"));
                });
                $turnoutsContainerBody.append($turnout);
                turnoutRequestStatus(turnout.data("track"));
            });
            cy.$(".signal").each(function (signal) {
                signalRequestStatus(signal.data("guarding"), signal.data("parentTrack"));
            });

            let URLsp = new URLSearchParams(window.location.search);
            $("#layoutEdit").prop("checked", URLsp.has("layoutEdit") ? "checked" : null)
                .trigger("change");
            $("#blockView").prop("checked", URLsp.has("blockView") ? "checked" : null)
                .trigger("change");
            $("#detectorDebug").prop("checked", URLsp.has("detectorDebug") ? "checked" : null)
                .trigger("change");

            return cy;
        }

        let layoutString = "";
        let layoutStringSizeReceived = 0;
        function updateRailwayLayout(data) {
            let offset = data.offset;
            let fullSize = data.fullSize;
            let partialLayout = data.layout;

            layoutStringSizeReceived += partialLayout.length;

            if (layoutString.length < fullSize)
                layoutString = new Array(fullSize + 1).join(" ");

            layoutString = [layoutString.slice(0, offset), partialLayout, layoutString.slice(offset + partialLayout.length)].join('');

            if (layoutStringSizeReceived === fullSize) {
                layout = JSON.parse(layoutString);
                if (checkGraphIsomorphism(railway, layout)) {
                    cy.destroy();
                    cy = cytoscapeCreate();
                    cy.add(layout.cy);
                    cy = cytoscapeUpdateData(cy, railway);
                    cy = cytoscapeUpdateSignals(cy, signals);
                    cy = cytoscapeUpdateBlocks(cy, blocks);
                    cy = cytoscapeUpdateDetectors(cy, detectors);
                    cy = cytoscapePostAdd(cy);

                    populateRoutesUI(routes);
                    cy = cytoscapeMarkSignalStartingRoute(routes, cy);

                    cy.viewport({ zoom: layout.viewport.zoom, pan: layout.viewport.pan });
                }
                else {
                    alert("railway and layout mismatch!");
                    /*    cy.destroy();
                        cy = cytoscapeCreate();
                        cy.add(layout.cy);
                        cy = cytoscapeUpdateRailway(cy, data.tracks);
                        cy = cytoscapeUpdateSignals(cy, signals);
                        cy = cytoscapeUpdateBlocks(cy, blocks);
                        cy = cytoscapePostAdd(cy);*/

                    cy.viewport({ zoom: layout.viewport.zoom, pan: layout.viewport.pan });
                }
            }
        }

        function checkGraphIsomorphism(railway, layout) {
            if (!layout || layout.length === 0 || !layout.cy)
                return false;

            let cyLayout = cytoscape();
            cyLayout.add(layout.cy);

            let success = true;
            _.each(railway, function (track, i) {

                let layoutTrack = cyLayout.$(".trackNode[name=\"" + track.name + "\"]");

                let localSuccess = layoutTrack !== undefined && layoutTrack.length > 0 &&
                    layoutTrack.data("connections").a === track.a &&
                    layoutTrack.data("connections").b === track.b &&
                    layoutTrack.data("connections").c === track.c &&
                    layoutTrack.data("connections").d === track.d;

                if (!localSuccess) {
                    console.log(track.name, layoutTrack, track, i);
                }

                success &&= localSuccess;
            });

            return success;
        }

        function graphCalculateReachability(event) {
            cy.elements().removeClass("reachable");
            function traverse($edge) {
                if ($edge.hidden())
                    return;

                $edge.addClass("reachable");
                let $nodes = $edge.connectedNodes();
                _.each($nodes, function ($node) {

                    if ($node.hasClass("reachable"))
                        return;

                    let $edges = $node.connectedEdges().filter(function (e) { return e !== $edge; });

                    if ($node.hasClass("turnout") || $node.hasClass("turnoutConnection")) {
                        $node.addClass("reachable");
                        _.each($edges, traverse);
                    }
                    else if ($node.hasClass("bumper")) {
                        // we came here somehow (via a), so there is nothing else to do
                        $node.addClass("reachable");
                    }
                    else //rail
                    {
                        $node.addClass("reachable");
                        _.each($edges, traverse);
                    }
                });
            }
            let $edge = cy.$(event.target);
            traverse($edge);
        }

        function cytoscapeUpdateData(cy, railway) {
            _.each(railway, function (track, i) {
                let node = cy.$(".trackNode[name=\"" + track.name + "\"]");
                node.data("address", track.address);
            });
            return cy;
        }

        function cytoscapeUpdateRailway(cy, railway) {
            _.each(railway, function (track, i) {
                let layoutTrack = cy.$(".trackNode[name=\"" + track.name + "\"]");

                // added track in railway list
                if (layoutTrack === undefined) {
                    addTrackToLayout(cy.nodes(), cy.edges(), railway.tracks, track, i);
                }

                let localSuccess = layoutTrack !== undefined && layoutTrack.length > 0 &&
                    layoutTrack.data("connections").a === track.a &&
                    layoutTrack.data("connections").b === track.b &&
                    layoutTrack.data("connections").c === track.c &&
                    layoutTrack.data("connections").d === track.d;

                if (!localSuccess) {
                    console.log(layoutTrack.data("name"), track, i);
                }
            });
            return cy;
        }

        function cytoscapeUpdateSignals(cy, signals) {
            let nodes = [];
            let edges = [];

            cy.$("node.signal").addClass("unverified");

            _.each(signals, function (signal, i) {
                let track = signal.parentTrack;
                let guarding = signal.guarding;
                let parentNode = guarding === "deadend"
                    ? "node.trackNode.bumper[track=\"" + track + "\"]"
                    : "node.connection." + guarding + "[track=\"" + track + "\"]";

                let parentPosition = cy.$(parentNode).position();
                let edgeTarget = guarding === "deadend"
                    ? cy.$(parentNode).id()
                    : track + "_" + guarding;

                let existing = cy.$("node.signal[parentTrack=\"" + track + "\"][guarding=\"" + guarding + "\"]");
                if (existing.length > 0) {
                    existing.removeClass("unverified");
                    existing.data("lights", signal.lights);
                }
                else {
                    let lights = signal.lights;
                    nodes.push({ group: 'nodes', data: { id: track + "_signal_" + guarding, guarding: guarding, parentTrack: track, lights: lights, relativePosition: { x: 0, y: 20 } }, position: { x: parentPosition.x, y: parentPosition.y + 20 }, classes: "signal" });
                    edges.push({ group: 'edges', data: { source: track + "_signal_" + guarding, target: edgeTarget }, classes: "signalConnector" });
                }
            });

            let unverified = cy.$(".unverified");
            console.log("removing " + unverified.length + " signals");
            unverified.remove();

            cy.add(nodes);
            cy.add(edges);

            return cy;
        }

        function cytoscapeMarkSignalStartingRoute(routes, cy) {
            _.each(routes, route => {
                let guarding = route.start;
                let track = route.path[0].track;
                let cySignal = cy.$("node.signal[parentTrack=\"" + track + "\"][guarding=\"" + guarding + "\"]");

                cySignal.addClass("routeStart");

                let knownRoutes = cySignal.data("routes");
                if (!knownRoutes)
                    knownRoutes = [];
                knownRoutes.push({id: route.id, name: route.name});
                cySignal.data("routes", knownRoutes);
            });
            return cy;
        }

        function cytoscapeUpdateBlocks(cy, blocks) {
            _.each(blocks, function (block, i) {
                _.each(block.tracks, function (track, j) {
                    cy.$("[track=\"" + track + "\"]").forEach(function (ele, i, eles) {
                        ele.data("block", block.address);
                        ele.data("blockColor", "#red");
                    });
                });
            });

            return cy;
        }

        function cytoscapeUpdateDetectors(cy, detectors) {
            let nodes = [];
            let edges = [];

            cy.$("node.detector").addClass("unverified");

            _.each(detectors, function (detector, i) {
                let id = detector.id;
                let track = detector.track;
                let connection = detector.connection;

                let parentPosition = cy.$("node.connection." + connection + "[track=\"" + track + "\"]").position();

                let existing = cy.$("node.detector[parentTrack=\"" + track + "\"][connection=\"" + connection + "\"]");
                if (existing.length > 0) {
                    existing.removeClass("unverified");
                }
                else {
                    nodes.push({ group: 'nodes', data: { detectorId: id, id: track + "_detector_" + connection, connection: connection, parentTrack: track, relativePosition: { x: 20, y: 0 } }, position: { x: parentPosition.x + 20, y: parentPosition.y }, classes: "detector" });
                    edges.push({ group: 'edges', data: { source: track + "_detector_" + connection, target: track + "_" + connection }, classes: "detector" });
                }
            });

            let unverified = cy.$(".unverified");
            console.log("removing " + unverified.length + " detectors");
            unverified.remove();

            cy.add(nodes);
            cy.add(edges);

            return cy;
        }

        /* cytoscape interaction */
        function cySplitEdge(event) {
            if (!cy || !allowLayoutEdit())
                return;

            cy.$('edge:selected').each(function (edge) {
                let nodes = edge.connectedNodes();
                let id = nodes[0].id() + "|" + nodes[1].id();
                let nodePosition = { x: (nodes[0].position().x + nodes[1].position().x) / 2.0, y: (nodes[0].position().y + nodes[1].position().y) / 2.0 };
                let parentTrack = nodes[0].data("track");
                let parentTrackNode = cy.$("#" + parentTrack);
                cy.add([
                    {
                        group: 'nodes', data: {
                            id: id,
                            track: nodes[0].data("track"),
                            relativePosition: { x: nodePosition.x - parentTrackNode.position().x, y: nodePosition.y - parentTrackNode.position().y }
                        },
                        position: nodePosition,
                        classes: "trackSplitNode"
                    },
                    { group: 'edges', data: { id: nodes[0].id() + "-" + id, track: nodes[0].data("track"), source: nodes[0].id(), target: id }, classes: "track" },
                    { group: 'edges', data: { id: id + "-" + nodes[1].id(), track: nodes[1].data("track"), source: id, target: nodes[1].id() }, classes: "track" }
                ]);
                edge.remove();
            });
            hideContextMenus();
        }

        function cyDeleteTrackNode(event) {
            if (!cy || !allowLayoutEdit())
                return;

            cy.$('node.trackSplitNode:selected').each(function (node) {
                let edges = node.connectedEdges();
                let neighbors = node.neighborhood("node");
                let id = neighbors[0].id() + "-" + neighbors[1].id();

                cy.add({ group: "edges", data: { id: id, source: neighbors[0].id(), target: neighbors[1].id() }, classes: "track" });

                edges.edges();
                node.remove();
            });
            hideContextMenus();
        }

        function cyPullNode(event) {
            if (!cy || !allowLayoutEdit())
                return;

            cy.$('node:selected').each(function (node) {
                let edges = node.connectedEdges();

                if (node.hasClass("connector")) {
                    let neighbor = node.openNeighborhood("node.connection");
                    neighbor.each((neigh, i) => {
                        let track = neigh.data("track");
                        cy.$('node.trackNode[track="' + track + '"]').each(function (n) {
                            let distance = Math.sqrt((neigh.position().x - node.position().x) * (neigh.position().x - node.position().x) + (neigh.position().y - node.position().y) * (neigh.position().y - node.position().y));
                            if (distance > 100)
                                n.position({ x: node.position().x + 40 * (i * 2 - 1), y: node.position().y }).emit("position");
                        });
                    });
                }
                else // connection
                {
                    let neighbor = node.openNeighborhood("node.connector");
                    let distance = Math.sqrt((neighbor.position().x - node.position().x) * (neighbor.position().x - node.position().x) + (neighbor.position().y - node.position().y) * (neighbor.position().y - node.position().y));
                    if (distance > 100)
                        neighbor.position({ x: node.position().x + 40, y: node.position().y }).emit("position");
                }
            });
            hideContextMenus();
        }

        /* railway and layout creation */
        let railwayString = "";
        let railwayStringSizeReceived = 0;
        function buildRailwayGraph(dataMsg) {
            let offset = dataMsg.offset;
            let fullSize = dataMsg.fullSize;
            let partialRailway = dataMsg.railway;

            railwayStringSizeReceived += partialRailway.length;

            if (railwayString.length < fullSize)
                railwayString = new Array(fullSize + 1).join(" ");

            railwayString = [railwayString.slice(0, offset), partialRailway, railwayString.slice(offset + partialRailway.length)].join('');

            if (railwayStringSizeReceived === fullSize) {

                let data = JSON.parse(railwayString);

                function classFromType(type) {
                    switch (type) {
                        case 0: return "bumper";
                        case 1: return "rail";
                        case 2: return "turnout";
                        case 3: return "doubleSlipTurnout";
                    }
                }

                let nodes = [];
                let edges = [];
                railway = data.tracks;
                signals = data.signals;
                blocks = data.blocks;
                detectors = data.detectors;
                routes = data.routes;

                _.each(data.tracks, function (track, i) {
                    addTrackToLayout(edges, nodes, data.tracks, track, i * 100);
                });

                cy = cytoscapeCreate();
                cy.add(nodes);
                cy.add(edges);
                cy = cytoscapeUpdateSignals(cy, data.signals);
                cy = cytoscapeUpdateBlocks(cy, data.blocks);
                cy = cytoscapeUpdateDetectors(cy, data.detectors);
                cy = cytoscapePostAdd(cy);

                populateRoutesUI(routes);
                cy = cytoscapeMarkSignalStartingRoute(routes, cy);

                if (allowLayoutLoading)
                    send("getRailwayLayout", {});
                else
                    allowLayoutLoading = true;
            }
        }

        function addTrackToLayout(edges, nodes, tracks, track, xPos) {
            function connect(that, otherTrackName, connectionName) {
                let other = _.find(tracks, t => t.name === otherTrackName);

                let thatNode = _.find(nodes, function (n) { return n.data.track === that; });
                let otherNode = _.find(nodes, function (n) { return n.data.track === otherTrackName; });

                if (thatNode === undefined || otherNode === undefined)
                    return;

                let from = that + "_" + connectionName;

                function connectToOther(otherConnectionName) {
                    if (other[otherConnectionName] === that) {
                        let to = otherTrackName + "_" + otherConnectionName;
                        let id = from + "-" + to;
                        nodes.push({ group: 'nodes', data: { id: id }, classes: "connector" });
                        edges.push({ group: 'edges', data: { source: from, target: id, track: that }, classes: "track" });
                        edges.push({ group: 'edges', data: { source: to, target: id, track: otherTrackName }, classes: "track" });
                    }
                }

                connectToOther("a");
                connectToOther("b");
                connectToOther("c");
                connectToOther("d");
            }

            let a = track.a;
            let b = track.b;
            let c = track.c;
            let d = track.d;
            let id = track.name;

            let type = 0;
            if (d !== undefined)
                type = 3;
            else if (c !== undefined)
                type = 2;
            else if (b !== undefined)
                type = 1;

            if (type === 3) {
                nodes.push({ group: 'nodes', data: { id: id, displayName: track.name, name: id, track: id, lengths: track.lengths, connections: { a: a, b: b, c: c, d: d }, direction: 1, type: "doubleSlipTurnout", relativePosition: { x: 0, y: 0 } }, position: { x: xPos, y: 0 }, classes: "trackNode turnout" });
                nodes.push({ group: 'nodes', data: { id: id + "_a", name: id + "_a", track: id, relativePosition: { x: -20, y: 0 } }, position: { x: xPos - 20, y: 0 }, classes: "turnoutConnection connection a" });
                nodes.push({ group: 'nodes', data: { id: id + "_b", name: id + "_b", track: id, relativePosition: { x: 20, y: 0 } }, position: { x: xPos + 20, y: -20 }, classes: "turnoutConnection connection b" });
                nodes.push({ group: 'nodes', data: { id: id + "_c", name: id + "_c", track: id, relativePosition: { x: 20, y: 20 } }, position: { x: xPos + 20, y: 20 }, classes: "turnoutConnection connection c" });
                nodes.push({ group: 'nodes', data: { id: id + "_d", name: id + "_d", track: id, relativePosition: { x: -20, y: 20 } }, position: { x: xPos - 20, y: 20 }, classes: "turnoutConnection connection d" });

                edges.push({ group: 'edges', data: { source: id, target: id + "_a", track: id, connection: "a" }, classes: "internal" });
                edges.push({ group: 'edges', data: { source: id, target: id + "_b", track: id, connection: "b" }, classes: "internal" });
                edges.push({ group: 'edges', data: { source: id, target: id + "_c", track: id, connection: "c" }, classes: "internal" });
                edges.push({ group: 'edges', data: { source: id, target: id + "_d", track: id, connection: "d" }, classes: "internal" });
            }
            else if (type === 2) {
                nodes.push({ group: 'nodes', data: { id: id, displayName: track.name, name: id, track: id, lengths: track.lengths, connections: { a: a, b: b, c: c }, direction: 1, type: "turnout", relativePosition: { x: 0, y: 0 } }, position: { x: xPos, y: 0 }, classes: "trackNode turnout" });
                nodes.push({ group: 'nodes', data: { id: id + "_a", name: id + "_a", track: id, relativePosition: { x: -20, y: 0 } }, position: { x: xPos - 20, y: 0 }, classes: "turnoutConnection connection a" });
                nodes.push({ group: 'nodes', data: { id: id + "_b", name: id + "_b", track: id, relativePosition: { x: 20, y: 0 } }, position: { x: xPos + 20, y: -20 }, classes: "turnoutConnection connection b" });
                nodes.push({ group: 'nodes', data: { id: id + "_c", name: id + "_c", track: id, relativePosition: { x: 20, y: 20 } }, position: { x: xPos + 20, y: 20 }, classes: "turnoutConnection connection c" });

                edges.push({ group: 'edges', data: { source: id, target: id + "_a", track: id, connection: "a" }, classes: "track" });
                edges.push({ group: 'edges', data: { source: id, target: id + "_b", track: id, connection: "b" }, classes: "internal" });
                edges.push({ group: 'edges', data: { source: id, target: id + "_c", track: id, connection: "c" }, classes: "internal" });
            }
            else if (type === 1) {
                nodes.push({ group: 'nodes', data: { id: id, displayName: track.name, name: id, track: id, length: track.length, connections: { a: a, b: b }, type: "rail", relativePosition: { x: 0, y: 0 } }, position: { x: xPos, y: 0 }, classes: "trackNode rail" });
                nodes.push({ group: 'nodes', data: { id: id + "_a", name: id + "_a", track: id, relativePosition: { x: -20, y: 0 } }, position: { x: xPos - 20, y: 0 }, classes: "railConnection connection a" });
                nodes.push({ group: 'nodes', data: { id: id + "_b", name: id + "_b", track: id, relativePosition: { x: 20, y: 0 } }, position: { x: xPos + 20, y: 0 }, classes: "railConnection connection b" });

                edges.push({ group: 'edges', data: { source: id, target: id + "_a", track: id, connection: "a" }, classes: "track" });
                edges.push({ group: 'edges', data: { source: id, target: id + "_b", track: id, connection: "b" }, classes: "track" });
            }
            else {
                nodes.push({ group: 'nodes', data: { id: id, displayName: track.name, name: id, track: id, length: track.length, connections: { a: a }, type: "bumper", relativePosition: { x: 0, y: 0 } }, position: { x: xPos, y: 0 }, classes: "trackNode bumper" });
                nodes.push({ group: 'nodes', data: { id: id + "_a", name: id + "_a", track: id, relativePosition: { x: -20, y: 0 } }, position: { x: xPos - 20, y: 0 }, classes: "bumperConnection connection a" });
                edges.push({ group: 'edges', data: { source: id, target: id + "_a", track: id, connection: "a" }, classes: "track" });
            }

            console.log("added track " + id);

            if (a !== undefined) connect(id, a, "a");
            if (b !== undefined) connect(id, b, "b");
            if (c !== undefined) connect(id, c, "c");
            if (d !== undefined) connect(id, d, "d");
        }

        $(function () {
            let URLsp = new URLSearchParams(window.location.search);
            $("#ip").on('change', () => {
                putStateIntoURL();
            }).val(URLsp.get('ipport') || "127.0.0.1:8080");
            connect();

            $railway = $("#railway");
            $("#splitEdge").on('click', cySplitEdge);
            $("#deleteTrackNode").on('click', cyDeleteTrackNode);
            $("#pullConnectedNode").on('click', cyPullNode);
            $(".cancel").on('click', function (event) {
                $(".contextMenu").hide();
                cy.$().unselect();
            });
            $("#settingsToggle").on('click', function () { $("#settingsContent").toggle(); });
            $("#logsToggle").on('click', function () { $("#logsContent").toggle(); });

            hideContextMenus();
            $("#settingsContent").hide();
            $("#logsContent").hide();

            $saveLayout = $("#saveLayout");
            $saveLayout.on('click', function () {
                if (allowLayoutStorage === true) {
                    allowLayoutStorage = false;
                    $saveLayout.addClass("disabled");
                    storeRailwayLayout();
                }
            });
            $saveLayout.addClass("disabled");

            $resetLayout = $("#resetLayout");
            $resetLayout.on('click', function () {
                allowLayoutLoading = false;
                send("getRailway", {});
            });
            $resetLayout.addClass("disabled");

            $("#layoutEdit").on('change', function (event) {
                uiEditLayout = $(event.target).prop("checked");
                if (!allowLayoutEdit()) {
                    cy.nodes().ungrabify();
                    $saveLayout.addClass("disabled");
                    $resetLayout.addClass("disabled");
                }
                else {
                    cy.nodes().grabify();
                    if (allowLayoutStorage === true) {
                        $saveLayout.removeClass("disabled");
                        $resetLayout.removeClass("disabled");
                    }
                }
                putStateIntoURL();
            });
            $("#blockView").on('change', function (event) {
                if ($(event.target).prop("checked"))
                    cy.$("[blockColor]").addClass("blockColoring");
                else
                    cy.$().removeClass("blockColoring");
                putStateIntoURL();
            });
            $("#detectorDebug").on('change', (event) => {
                if ($(event.target).prop("checked"))
                    cy.$(".detector").style("display", "element");
                else
                    cy.$(".detector").style("display", "none");
                putStateIntoURL();
            });

            $("#reconnect").on('click', function () {
                connect();
                onConnect();
            });

            $("#stop").on('click', () => {
                send("toggleDCSstop");
            });

            M.Sidenav.init($('#sideLoco').get(0), { edge: "right" }).open();
            M.Sidenav.init($('#sideTurnout').get(0), { edge: "left" }).open();

            M.AutoInit();
            M.FormSelect.init(document.querySelectorAll('select'));

            onConnect();
        });

        function putStateIntoURL() {
            var url = window.location.protocol + "//" + window.location.host + window.location.pathname + '?';
            url += "ipport=" + $("#ip").val();
            if ($("#gridView").prop("checked"))
                url += "&gridView";
            if ($("#layoutEdit").prop("checked"))
                url += "&layoutEdit";
            if ($("#blockView").prop("checked"))
                url += "&blockView";
            if ($("#detectorDebug").prop("checked"))
                url += "&detectorDebug";
            window.history.pushState({ path: url }, '', url);
        }

    </script>
    <script type="text/javascript" src="materialize.min.js"></script>
    <script type="text/javascript" src="cytoscape.min.js"></script>
    <script type="text/javascript" src="cytoscape-grid-guide.js"></script>
    <script type="text/javascript" src="cytoscape-node-html-label.min.js"></script>
</body>

</html>